name: cassandra-stack

volumes:
  cassandra_data:

networks:
  default:
    name: cassandra

services:

# -------------------------------------------------------------------------------------------------
# Cassandra Services
# -------------------------------------------------------------------------------------------------
  cassandra:
    image: cassandra:5
    container_name: cassandra
    restart: unless-stopped    
    ports:
      - "9042:9042"
    volumes:
      - cassandra_data:/var/lib/cassandra
    networks:
      - default
    environment:
      - JVM_MAX_HEAP_SIZE=2048M 
      - JVM_INITIAL_HEAP_SIZE=2048M
      - CASSANDRA_CLUSTER_NAME=flyway_lab_cluster
      - CASSANDRA_RACK=rack1
      - CASSANDRA_DC=datacenter1
      - CASSANDRA_SEEDS=cassandra
      - CASSANDRA_ENDPOINT_SNITCH=GossipingPropertyFileSnitch
    healthcheck:
      test: ["CMD", "cqlsh", "cassandra", "9042", "-e", "DESCRIBE cluster"]
      interval: 10s
      timeout: 5s
      retries: 10

  cassandra-client:
    image: cassandra:5
    container_name: cassandra-client
    volumes:
      - ./:/workspace:ro
    networks:
      - default
    depends_on:
      cassandra:
        condition: service_healthy
    # Keep container running for interactive use
    command: ["tail", "-f", "/dev/null"]
    # Optional: add any development tools you commonly use
    environment:
      - CQLSH_HOST=cassandra
      - CQLSH_PORT=9042

# -------------------------------------------------------------------------------------------------
# Flyway Services
# -------------------------------------------------------------------------------------------------
  flyway:
      profiles: ["flyway"]
      container_name: flyway
      image: flyway/flyway:11-alpine
      entrypoint: /bin/sh
      command: -c "flyway info"
      environment:
        - FLYWAY_URL=jdbc:cassandra://cassandra:9042?localdatacenter=datacenter1&requesttimeout=30000
        - FLYWAY_LOCATIONS=filesystem:/flyway/sql
        - FLYWAY_SQL_MIGRATION_SUFFIXES=.cql
        - FLYWAY_SCHEMAS=migrations,customers
        - FLYWAY_DEFAULT_SCHEMA=migrations
        - FLYWAY_CONNECT_RETRIES=10
        - FLYWAY_CLEAN_DISABLED=false
        - FLYWAY_EXECUTE_IN_TRANSACTION=false
        - FLYWAY_IGNORE_MIGRATION_PATTERNS=*:pending
      volumes:
        - ./migrations:/flyway/sql
      networks:
        - default