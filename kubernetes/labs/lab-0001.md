# Lab: Submit request to Kubernetes API Server using curl

**Status**:

  COMPLETED

**Tags**:

  - TAG-K8s
  - TAG-K8s-APISERVER
  - TAG-K8s-POD

---

## Objective

As an alternative to using the `kubectl` command to interact with `kube-apiserver`, the objective is to demonstrate how to make standard http requests to the `kube-apiserver` using the `curl` utility.

---

## Background

To submit a request to the Kubernetes API (`kube-apiserver`) using `curl`, you need to provide

- the API server's address
- a bearer token for authentication
- the path to the API endpoint.

You'll also need to manage the certificate authority (CA) certificate to establish a secure connection, as the API server uses TLS.

This information will be used when submitting a `curl` request:

```bash
curl --cacert <path-to-ca-cert> -H "Authorization: Bearer <your-bearer-token>" <api-server-address>/<api-path>
```

---

## Environment Setup

- **Operating System**: Ubuntu 24.04

- **Software/Tools**:
  - Docker v28 + Kubernetes Enabled
  - linux utils: grep, cat, sed, awk
  - yq

---

## Procedure

### Step 1: Find the Kubernetes API Server Address

You can find the API server's address by examining your kubeconfig file. The server address is usually located under the clusters section.

```yaml
clusters:
- cluster:
    certificate-authority-data: <certificate-data>
    server: https://<kubernetes-api-server-address>:6443
  name: kubernetes
```

Try any of the following methods:

- **<ins>Method 1: Use grep</ins>**

  ```bash
  cat ~/.kube/config | grep -A 3 '^- cluster:'
  ```

  ```yaml
  - cluster:
      certificate-authority-data: XXXXXXXXXXXXXXXXXXX
      server: https://kubernetes.docker.internal:6443
    name: docker-desktop
  ```

- **<ins>Method 2: Using awk</ins>**

  ```bash
  cat ~/.kube/config | awk '/^- cluster:/ {p=1} p&&/server|name:/ {print} /^contexts:/ {p=0}'
  ```

  ```yaml
    server: https://kubernetes.docker.internal:6443
    name: docker-desktop
  ```

  Explanation:

  - `/^- cluster:/ {p=1}` sets a flag p to 1 when the cluster block starts.
  - `p&&/server|name:/ {print}` prints lines containing the desired fields while p is 1.
  - `/^contexts:/ {p=0}` stops printing when the contexts section begins.

  This approach ensures we only capture the cluster section.

- **<ins>Method 3: Using sed</ins>**

  ```bash
  cat ~/.kube/config | sed -n '/^- cluster:/,/^contexts:/p' | grep -v '^contexts:'
  cat ~/.kube/config | sed -n '/^- cluster:/,/^contexts:/p' | grep -v '^contexts:' | grep -v 'certificate-authority-data:'
  ```

  ```yaml
  - cluster:
      certificate-authority-data: XXXXXXXXXXXXXXXXXXX
      server: https://kubernetes.docker.internal:6443
    name: docker-desktop
  ```

  ```bash
  cat ~/.kube/config | sed -n '/^- cluster:/,/^contexts:/p' | grep -v '^contexts:' | grep -v 'certificate-authority-data:'
  ```

  ```yaml
  - cluster:
      server: https://kubernetes.docker.internal:6443
    name: docker-desktop
  ```

  Explanation:

  - `-n` suppresses default output.
  - `/^- cluster:/,/^contexts:/p` prints lines from `- cluster:` to `contexts:`.
  - `grep -v '^contexts:'` excludes the `contexts:` line.
  - `grep -v '^certificate-authority-data:'` excludes the `certificate-authority-data:` line.

  To extract specific fields, you‚Äôd need additional sed or grep commands, e.g., sed -n 's/.*server: //p' for the certificate data.

  ```bash
  CLUSTER_SERVER=$(cat ~/.kube/config | sed -n '/^- cluster:/,/^contexts:/p' | sed -n 's/.*server: //p')
  CLUSTER_NAME=$(cat ~/.kube/config | sed -n '/^- cluster:/,/^contexts:/p' | sed -n 's/.*name: //p')
  ```

- **<ins>Method 4: Use yq</ins>**

  ```bash
  cat ~/.kube/config | yq '.clusters[0] | {name: .name, server: .cluster.server}'
  ```

  ```json
  {
    "name": "docker-desktop",
    "server": "https://kubernetes.docker.internal:6443"
  }
  ```

  ```bash
  CLUSTER_SERVER=$(cat ~/.kube/config | yq '.clusters[].cluster.server' --raw-output)
  CLUSTER_NAME=$(cat ~/.kube/config | yq '.clusters[].name' --raw-output)
  ```

- **<ins>Method 5: Use kubectl</ins>**

  ```bash
  kubectl config view --minify
  ```

  ```yaml
  apiVersion: v1
  clusters:
  - cluster:
      certificate-authority-data: DATA+OMITTED
      server: https://kubernetes.docker.internal:6443
    name: docker-desktop
  kind: Config
  preferences: {}
  ```

  ```bash
  CLUSTER_SERVER=$(kubectl config view --minify -o yaml | yq '.clusters[].cluster.server' --raw-output)
  CLUSTER_NAME=$(kubectl config view --minify -o yaml | yq '.clusters[].name' --raw-output)

  # or
  CLUSTER_SERVER=$(kubectl config view --raw -o jsonpath='{.clusters[0].cluster.server}')
  CLUSTER_NAME=$(kubectl config view --raw -o jsonpath='{.clusters[0].name}')
  ```

### Step 2: Get a Bearer Token

The most common method for authentication with `curl` is to use a `bearer token` from a `service account`.

> [!IMPORTANT]
>
> - **Service Account**: A special kind of non-human user that provides an identity for processes running inside a pod. It allows these processes to be authenticated and authorized by the Kubernetes API server, enabling them to interact with other cluster resources.
> - **Bearer Token** - A type of security credential that grants access to a resource simply by being presented. The name "bearer" means that whoever "bears" or holds the token is authorized to use it, without any further proof of identity. Think of it like a concert ticket üé´ ‚Äî anyone who has the ticket can get into the show, regardless of who they are.

- <ins>Step 2.1: Create Service Account</ins>
  
  ```bash
  kubectl create sa my-service-account
  ```

- <ins>Step 2.2: Create a token secret for the service account</ins>
  
  ```bash
  kubectl create token my-service-account
  ```

  This command will output the token directly.

### Step 3: Assign permissions to Service Account

The service account requires permissions to list pods. Assign permissions by creating a `Role` (which defines the permissions) and a `RoleBinding` (which links the role to the service account).

- <ins>Step 3.1: Create Role</ins>
  
  First, create a Role that allows the list verb on the pods resource.

  Create a file named `pod-reader-role.yaml` with the following content:

  ```yaml
  apiVersion: rbac.authorization.k8s.io/v1
  kind: Role
  metadata:
    name: pod-reader
    namespace: default
  rules:
  - apiGroups: [""] # The core API group
    resources: ["pods"]
    verbs: ["get", "list", "watch"]
  ```

  Apply the role to the cluster:
  
  ```bash
  kubectl apply -f pod-reader-role.yaml
  ```

- <ins>Step 3.2: Create a RoleBinding</ins>
  
  Next, you need to bind this Role to your specific service account.
  
  Create a file named `pod-reader-rolebinding.yaml` with the following content:

  ```yaml
  apiVersion: rbac.authorization.k8s.io/v1
  kind: RoleBinding
  metadata:
    name: read-pods-rolebinding
    namespace: default
  subjects:
  - kind: ServiceAccount
    name: test-service-account # The name of your service account
    namespace: default
  roleRef:
    kind: Role
    name: pod-reader # The name of the role you created
    apiGroup: rbac.authorization.k8s.io
  ```

  Apply the role binding to the cluster:

  ```bash
  kubectl apply -f pod-reader-rolebinding.yaml
  ```

  Once these steps are completed, your `my-service-account` will have the necessary permissions to list pods in the `default namespace`, and your `curl` request should succeed.

### Step 4: 3. Get the CA Certificate

For secure communication, `curl` needs to trust the API server's certificate. You can get the CA certificate from your kubeconfig file.

```bash
kubectl config view --raw -o jsonpath='{.clusters[0].cluster.certificate-authority-data}' | base64 --decode > ca.crt
```

Explanation:

- `kubectl config view --raw -o jsonpath='{.clusters[0].cluster.certificate-authority-data}'` extracts value of `certificate-authority-data` as raw text. This value is base64 encoded.
- `base64 --decode > ca.crt` decodes the base64 data and saves it to a file named `ca.crt`.

### Step 5: List Pods

Once Steps 1-4 are complete, you can construct the curl command. The basic syntax is:

```bash
curl --cacert <path-to-ca-cert> \
  -H "Authorization: Bearer <your-bearer-token>" \
  <api-server-address>/<api-path>
```

Let's say you want to list all pods in the default namespace.

- API Server Address:
  
  ```bash
  CLUSTER_SERVER=$(kubectl config view --raw -o jsonpath='{.clusters[0].cluster.server}')
  ```

- Token:
  
  ```bash
  BEARER_TOKEN=$(kubectl create token my-service-account)
  ```

- CA Cert: `ca.crt`

- API Path: `/api/v1/namespaces/default/pods`

The final `curl` command will be:

```bash
curl --cacert ca.crt \
  -H "Authorization: Bearer $BEARER_TOKEN" \
  "$CLUSTER_SERVER/api/v1/namespaces/default/pods"
```

---

## Results

Provided that all the steps were completed as outlined by the [Procedure](#procedure) above, one should be able to run the following commands to obtain a valid result.

```bash
CLUSTER_SERVER=$(kubectl config view --raw -o jsonpath='{.clusters[0].cluster.server}'

BEARER_TOKEN=$(kubectl create token my-service-account)

curl --cacert ca.crt \
  -H "Authorization: Bearer $BEARER_TOKEN" \
  "$CLUSTER_SERVER/api/v1/namespaces/default/pods"
```

```json
üñ•Ô∏è <<output>> üñ•Ô∏è

{
  "kind": "PodList",
  "apiVersion": "v1",
  "metadata": {
    "resourceVersion": "756610"
  },
  "items": []
}
```

---
